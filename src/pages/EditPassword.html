<!DOCTYPE html>
<html lang="kr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="/fonts/Fonts.css" />
    <link rel="stylesheet" href="../components/common/header/Header.css" />
    <link rel="stylesheet" type="text/css" href="./EditPassword.css" />
    <title>김진아</title>
  </head>
  <body>
    <head>
      <script src="../components/common/header/Header.js" defer></script>
    </head>
    <main>
      <div class="login">
        <p class="loginHeader">비밀번호 수정</p>
        <div class="login-container">
          <form onsubmit="return handleLogin(event)">
            <div class="form-group">
              <label for="password">비밀번호</label>
              <input
                type="password"
                id="password"
                placeholder="비밀번호를 입력하세요"
              />
            </div>
            <div class="helper-text"></div>
            <div class="form-group">
              <label for="passwordConfirm">비밀번호 확인</label>
              <input
                type="password"
                id="passwordConfirm"
                placeholder="비밀번호를 한번 더 입력하세요"
              />
            </div>
            <div class="helper-text"></div>
            <button type="submit" class="login-button" disabled>
              수정하기
            </button>
          </form>
        </div>
      </div>
    </main>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const passwordInput = document.getElementById("password");
        const passwordConfirmInput = document.getElementById("passwordConfirm");
        const helperTexts = document.querySelectorAll(".helper-text");
        const loginBtn = document.querySelector(".login-button");

        let isPasswordValid = false;
        let isPasswordConfirmValid = false;

        function checkValid() {
          loginBtn.disabled = !(isPasswordValid && isPasswordConfirmValid);
        }

        passwordInput.addEventListener("input", function () {
          const password = passwordInput.value.trim();
          const passwordConfirm = passwordConfirmInput.value.trim();

          if (!password) {
            helperTexts[0].textContent = "*비밀번호를 입력해주세요.";
            isPasswordValid = false;
            return;
          } else if (
            password.length < 8 ||
            password.length > 20 ||
            !/[A-Z]/.test(password) ||
            !/[a-z]/.test(password) ||
            !/[0-9]/.test(password) ||
            !/[^A-Za-z0-9]/.test(password)
          ) {
            helperTexts[0].textContent =
              "*비밀번호는 8자 이상, 20자 이하이며, 대문자, 소문자, 숫자, 특수문자를 각각 최소 1개 포함해야 합니다.";
            isPasswordValid = false;
            return;
          } else {
            helperTexts[0].textContent = "";
            isPasswordValid = true;
          }
          checkValid();
        });

        passwordConfirmInput.addEventListener("input", function () {
          const password = passwordInput.value.trim();
          const passwordConfirm = passwordConfirmInput.value.trim();

          if (!passwordConfirm) {
            helperTexts[1].textContent = "*비밀번호를 한번 더 입력해주세요.";
            isPasswordConfirmValid = false;
            return;
          }
          if (password !== passwordConfirm) {
            helperTexts[1].textContent = "비밀번호와 다릅니다.";
            isPasswordConfirmValid = false;
            return;
          } else {
            helperTexts[1].textContent = "";
            isPasswordConfirmValid = true;
          }
          checkValid();
        });
      });

      function handleLogin(event) {
        event.preventDefault();

        const password = document.getElementById("password").value.trim();
        const passwordConfirm = document
          .getElementById("passwordConfirm")
          .value.trim();
        let currentUser = JSON.parse(localStorage.getItem("currentUser"));
        let users = JSON.parse(localStorage.getItem("users")) || [];

        const userIndex = users.findIndex((user) => user.id === currentUser.id);
        if (userIndex === -1) {
          alert("사용자 정보를 찾을 수 없습니다.");
          return;
        }

        users[userIndex].password = password;
        currentUser.password = password;
        localStorage.setItem("users", JSON.stringify(users));
        localStorage.setItem("currentUser", JSON.stringify(currentUser));

        showToast("수정완료");

        setTimeout(() => {
          window.location.href = "../pages/PostList.html";
        }, 1000);
      }

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");
      }
    </script>
    <div id="toast" class="toast">임시 메시지</div>
  </body>
</html>
